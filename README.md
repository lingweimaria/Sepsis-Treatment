# Sepsis DRL Data Pipeline

## ç›®å½•ç»“æ„

```
data_pipeline/
â”œâ”€â”€ raw_data/                    # åŸå§‹æ•°æ®
â”‚   â””â”€â”€ mimic3_original/        # MIMIC-IIIåŸå§‹æ•°æ®æ–‡ä»¶
â”œâ”€â”€ processed_data/             # å¤„ç†åæ•°æ®
â”‚   â”œâ”€â”€ complete_sofa_data/     # å®Œæ•´SOFAè¯„åˆ†æ•°æ®
â”‚   â”œâ”€â”€ intermediate/           # ä¸­é—´å¤„ç†æ•°æ®
â”‚   â””â”€â”€ final/                  # æœ€ç»ˆè®­ç»ƒæ•°æ®
â”œâ”€â”€ preprocessing_scripts/      # æ•°æ®å¤„ç†è„šæœ¬
â”œâ”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”œâ”€â”€ configs/                    # é…ç½®æ–‡ä»¶
â””â”€â”€ README.md                   # æœ¬æ–‡ä»¶
```

## æ•°æ®æµç¨‹

### 1. åŸå§‹æ•°æ® (raw_data/mimic3_original/)
- `time series variables(vital signs)_mimic3.csv` - ç”Ÿå‘½ä½“å¾æ—¶é—´åºåˆ—
- `static variables(demographics)_mimic3.csv` - äººå£ç»Ÿè®¡å­¦é™æ€å˜é‡
- `static variables(weight_height)_mimic3.csv` - èº«é«˜ä½“é‡æ•°æ®
- `top 1000 medications_mimic3.csv` - è¯ç‰©æ•°æ®
- `time series variables(output)_mimic3.csv` - è¾“å‡ºé‡æ•°æ®
- `filtered_static_ts.csv` - è¿‡æ»¤åçš„é™æ€æ—¶é—´åºåˆ—

### 2. ä¸­é—´å¤„ç†æ•°æ® (processed_data/intermediate/)
- `vital_signs_processed.csv` - å¤„ç†åç”Ÿå‘½ä½“å¾
- `demographics_processed.csv` - å¤„ç†åäººå£ç»Ÿè®¡å­¦æ•°æ®
- `weight_height_processed.csv` - å¤„ç†åèº«é«˜ä½“é‡
- `medications_processed.csv` - å¤„ç†åè¯ç‰©æ•°æ®
- `gcs_processed.csv` - GCSè¯„åˆ†æ•°æ®

### 3. SOFAè¯„åˆ†æ•°æ® (processed_data/complete_sofa_data/)
- `enhanced_sofa_dataset.csv` - å¢å¼ºSOFAæ•°æ®é›†
- `sofa_data_report.json` - SOFAæ•°æ®æŠ¥å‘Š

### 4. æœ€ç»ˆè®­ç»ƒæ•°æ® (processed_data/final/)
- `train_features.npy` - è®­ç»ƒç‰¹å¾
- `val_features.npy` - éªŒè¯ç‰¹å¾  
- `test_features.npy` - æµ‹è¯•ç‰¹å¾
- `train_metadata.csv` - è®­ç»ƒå…ƒæ•°æ®
- `val_metadata.csv` - éªŒè¯å…ƒæ•°æ®
- `test_metadata.csv` - æµ‹è¯•å…ƒæ•°æ®
- `feature_info.csv` - ç‰¹å¾ä¿¡æ¯

## å¤„ç†è„šæœ¬è¯´æ˜

### æ ¸å¿ƒå¤„ç†è„šæœ¬
1. **sepsis_data_preprocessing.py** - è´¥è¡€ç—‡æ•°æ®é¢„å¤„ç†ä¸»è„šæœ¬
2. **enhanced_sofa_calculator.py** - å¢å¼ºSOFAè¯„åˆ†è®¡ç®—å™¨


## SOFAè¯„åˆ†è®¡ç®—

SOFA (Sequential Organ Failure Assessment) è¯„åˆ†åŒ…å«6ä¸ªå™¨å®˜ç³»ç»Ÿï¼š

1. **å‘¼å¸ç³»ç»Ÿ** - SpO2/FiO2æ¯”å€¼ (0-4åˆ†)
2. **å¿ƒè¡€ç®¡ç³»ç»Ÿ** - å¹³å‡åŠ¨è„‰å‹ + è¡€ç®¡åŠ å‹è¯ (0-4åˆ†)
3. **ä¸­æ¢ç¥ç»ç³»ç»Ÿ** - GCSè¯„åˆ† (0-4åˆ†)
4. **è‚¾è„ç³»ç»Ÿ** - è‚Œé… + å°¿é‡ (0-4åˆ†)
5. **å‡è¡€ç³»ç»Ÿ** - è¡€å°æ¿è®¡æ•° (0-4åˆ†) [æ•°æ®ç¼ºå¤±]
6. **è‚è„ç³»ç»Ÿ** - èƒ†çº¢ç´  (0-4åˆ†) [æ•°æ®ç¼ºå¤±]

### å¯ç”¨æŒ‡æ ‡
- âœ… GCSè¯„åˆ† (çœ¼éƒ¨ã€è¨€è¯­ã€è¿åŠ¨ååº”)
- âœ… ç”Ÿå‘½ä½“å¾ (è¡€å‹ã€å¿ƒç‡ã€å‘¼å¸é¢‘ç‡ã€ä½“æ¸©ã€SpO2)
- âœ… å®éªŒå®¤æŒ‡æ ‡ (è‚Œé…ã€è¡€ç³–ã€ä¹³é…¸ã€pHå€¼)
- âœ… è¡€ç®¡åŠ å‹è¯ä½¿ç”¨æƒ…å†µ
- âœ… å°¿é‡æ•°æ®
- âŒ è¡€å°æ¿è®¡æ•° (éœ€è¦LABEVENTSè¡¨)
- âŒ èƒ†çº¢ç´  (éœ€è¦LABEVENTSè¡¨)

## ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œå®Œæ•´æ•°æ®å¤„ç†æµæ°´çº¿
```bash
python run_complete_pipeline.py
```

### 2. åªè¿è¡Œæ¨¡å‹è®­ç»ƒ (åŒ…å«å¯è§†åŒ–)
```bash
python fixed_sepsis_training.py
```

### 3. å•ç‹¬è¿è¡ŒSOFAè®¡ç®—
```bash
python preprocessing_scripts/enhanced_sofa_calculator.py
```

### 4. è¿è¡Œè´¥è¡€ç—‡é¢„å¤„ç†
```bash
python preprocessing_scripts/sepsis_data_preprocessing.py
```

## æ•°æ®è´¨é‡

- **è®­ç»ƒåºåˆ—**: ~1000-5000ä¸ªæœ‰æ•ˆåºåˆ—
- **éªŒè¯åºåˆ—**: ~200-1000ä¸ªæœ‰æ•ˆåºåˆ—
- **ç‰¹å¾ç»´åº¦**: é€šå¸¸12-15ä¸ªç‰¹å¾
- **åºåˆ—é•¿åº¦**: å›ºå®šä¸º7ä¸ªæ—¶é—´æ­¥
- **æ•°æ®å®Œæ•´æ€§**: çº¦60-80% (å–å†³äºå…·ä½“æŒ‡æ ‡)

## å¼ºåŒ–å­¦ä¹ é›†æˆ

å¤„ç†åçš„æ•°æ®ç›´æ¥ç”¨äºå¼ºåŒ–å­¦ä¹ è®­ç»ƒï¼š
- **çŠ¶æ€ç©ºé—´**: å¤šç»´ç”Ÿå‘½ä½“å¾ + SOFAè¯„åˆ†
- **åŠ¨ä½œç©ºé—´**: 20ç§æ²»ç–—åŠ¨ä½œ
- **å¥–åŠ±å‡½æ•°**: åŸºäºSOFAæ”¹å–„ã€ç”Ÿå‘½ä½“å¾ç¨³å®šæ€§ç­‰ä¸´åºŠæŒ‡æ ‡

### æ¨¡å‹è®­ç»ƒåŠŸèƒ½ (fixed_sepsis_training.py)
- **LSTMæ™ºèƒ½ä½“**: å¢å¼ºçš„è´¥è¡€ç—‡LSTMæ™ºèƒ½ä½“ï¼ŒåŒ…å«æ³¨æ„åŠ›æœºåˆ¶
- **ä¸´åºŠå¥–åŠ±è®¡ç®—**: åŸºäºåŒ»å­¦æŒ‡æ ‡çš„å¥–åŠ±å‡½æ•°
- **åŒ»å­¦å®‰å…¨çº¦æŸ**: é˜²æ­¢å±é™©æ²»ç–—ç»„åˆ
- **è®­ç»ƒå¯è§†åŒ–**: è‡ªåŠ¨ç”Ÿæˆè®­ç»ƒæ›²çº¿å›¾è¡¨
- **æ¨¡å‹ä¿å­˜**: è‡ªåŠ¨ä¿å­˜æœ€ä½³æ¨¡å‹å’Œæ£€æŸ¥ç‚¹

### ç”Ÿæˆçš„æ–‡ä»¶
è®­ç»ƒå®Œæˆåä¼šåœ¨ä»¥ä¸‹ä½ç½®ç”Ÿæˆæ–‡ä»¶ï¼š
- `models/enhanced_best_sepsis_agent.pth` - æœ€ä½³æ¨¡å‹
- `plots/` - è®­ç»ƒå¯è§†åŒ–å›¾è¡¨
  - `total_loss.png` - æ€»æŸå¤±æ›²çº¿
  - `clinical_rewards.png` - ä¸´åºŠå¥–åŠ±æ›²çº¿
  - `actor_critic_loss.png` - Actor-CriticæŸå¤±å¯¹æ¯”
  - `safety_violations.png` - å®‰å…¨è¿è§„æƒ…å†µ
  - `gradient_norm.png` - æ¢¯åº¦èŒƒæ•°
  - `learning_rate.png` - å­¦ä¹ ç‡è°ƒåº¦
- `enhanced_training_report.txt` - è®­ç»ƒæŠ¥å‘Š

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿MIMIC-IIIæ•°æ®è®¿é—®æƒé™
2. å¤„ç†è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨å¤„ç†ç¼ºå¤±å€¼
3. SOFAè¯„åˆ†è®¡ç®—å¯èƒ½ä¸å®Œæ•´ (ç¼ºå°‘è¡€å°æ¿å’Œèƒ†çº¢ç´ )
4. å»ºè®®åœ¨å¤„ç†å‰å¤‡ä»½åŸå§‹æ•°æ®

## æ›´æ–°
ğŸ”„ ä¼˜åŒ–å†…å®¹

  1. åŸºäºçœŸå®ä¸´åºŠæŒ‡å—çš„çº¦æŸ

  ### æ›´ç²¾å‡†çš„å±é™©ç»„åˆ
  è¡€ç®¡åŠ å‹è¯ + é™å‹è¯ï¼šç›¸äº’æŠµæ¶ˆ
  åˆ©å°¿å‰‚ + å¤§é‡ç”µè§£è´¨     # ç”µè§£è´¨ç´Šä¹±  
  é•‡ç—›å‰‚ + é•‡é™å‰‚       # è¿‡åº¦é•‡é™

  2. æ™ºèƒ½ç”Ÿç†çŠ¶æ€çº¦æŸ

  ä½è¡€å‹(<85mmHg) â†’ ç¦æ­¢é™å‹è¯ + é¼“åŠ±åŠ å‹è¯
  é«˜è¡€å‹(>160mmHg) â†’ é™åˆ¶åŠ å‹è¯
  å¿ƒåŠ¨è¿‡é€Ÿ(>130bpm) â†’ é¼“åŠ±Î²å—ä½“é˜»æ»å‰‚
  ä½æ°§(<90%) â†’ é¼“åŠ±æ°§ç–—

  3. æƒé‡é‡æ–°å¹³è¡¡

  #### æ–°æƒé‡åˆ†é…
  ä¸“å®¶æ¨¡ä»¿(SL): 40%    
  å¼ºåŒ–å­¦ä¹ (RL): åŸæƒé‡   
  å®‰å…¨çº¦æŸ: 5% ï¼šè¾…åŠ©ä¿æŠ¤ (é™ä½ä»10%)

  ğŸ¯ è®¾è®¡ç†å¿µ

  1. ä¸“å®¶æ•°æ®ä¸ºä¸»å¯¼ - çœŸå®åŒ»ç”Ÿå†³ç­–æ˜¯æœ€å¯é çš„
  2. å®‰å…¨çº¦æŸä¸ºä¿æŠ¤ - é˜²æ­¢æç«¯æƒ…å†µä¸‹çš„å±é™©å†³ç­–
  3. è½»é‡åŒ–çº¦æŸ - é¿å…è¿‡åº¦é™åˆ¶æ¨¡å‹å­¦ä¹ èƒ½åŠ›
